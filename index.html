<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>単語帳アプリ</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- 上部バー -->
  <div id="topBar">
    <div id="topBarLeft">
      <span id="appTitle">単語帳アプリ</span>
    </div>
    <div id="topBarRight">
      <label class="topBarBtn"><input type="file" id="fileInput" accept=".csv" style="display:none;"><span id="fileInputLabel">📁 ファイル選択</span></label>
      <button id="backToMenuBtn" class="topBarBtn">🏠 メニューに戻る</button>
      <button id="settingsBtn" class="topBarBtn">⚙️ 設定</button>
      <button id="globalStatsBtn" class="topBarBtn">📊 全体統計</button>
    </div>
  </div>

  <!-- 連続記録表示 -->
  <div id="streakDisplay" style="text-align:center; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:15px 0; margin-bottom:0;">
    <h1 id="streakTitle">🔥 連続学習: <span id="streakCount">0</span>日</h1>
    <div id="xpDisplay" style="font-size:1.2em; margin-top:10px;">
      <span id="totalXP">総XP: 0</span> | 
      <span id="currentLevel">レベル: 1</span> | 
      <span id="nextLevelXP">次のレベルまで: 1 XP</span>
    </div>
  </div>
  
  <!-- 設定パネルは削除 -->

  <!-- ステータス表示 -->
  <div id="statusText" style="margin-top: 10px; font-weight: bold;"></div>

  <!-- プログレスバー -->
  <div id="progressBar">
    <div id="progressFill"></div>
  </div>

  <!-- メニュー画面 -->
  <div id="menuScreen" style="display:none; text-align:center; margin-top:40px;">
    <h2>単語帳メニュー</h2>
    <div id="historyList"></div>
    <!-- <button id="loadNewBtn" style="margin-top:20px; font-size:1.1em;">新しい単語帳を読み込み</button> -->
  </div>

  <!-- 結果画面 -->
  <div id="resultScreen" style="display:none; text-align:center; margin-top:40px;">
    <h2>学習結果</h2>
    <div id="resultSummary"></div>
    
    <!-- 結果グラフセクション -->
    <div id="resultGraphs" style="margin: 30px 0;">
      <h3 style="color: #2c3e50; margin-bottom: 20px;">📊 統計グラフ</h3>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <!-- 平均回答時間グラフ -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h4 style="color: #3498db; margin-bottom: 15px;">⏱️ 平均回答時間</h4>
          <canvas id="resultAverageTimeChart"></canvas>
        </div>
        
        <!-- 平均正解率グラフ -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h4 style="color: #27ae60; margin-bottom: 15px;">✅ 平均正解率</h4>
          <canvas id="resultAccuracyChart"></canvas>
        </div>
      </div>
      
      <!-- 平均回答難易度グラフ -->
      <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <h4 style="color: #e74c3c; margin-bottom: 15px;">🎯 平均回答難易度（一回目の回答）</h4>
        <canvas id="resultDifficultyChart"></canvas>
      </div>
    </div>
    
    <div id="resultDetails"></div>
    <button id="resultToMenuBtn" class="result-menu-btn">
      <span class="btn-icon">🏠</span>
      <span class="btn-text">メニューに戻る</span>
    </button>
  </div>

  <!-- 中央：問題文表示 -->
  <div id="mainContent">
    <div id="question" class="questionText">問題が表示されます</div>
    <div id="answer" class="answerText">（答えを見るボタンを押してください）</div>
  </div>

  <!-- 下部：操作ボタン・メモ -->
  <div id="bottomBar">
    <button id="showAnswerBtn" onclick="showAnswer()">答えを見る</button>
    <div id="gradeButtons" style="display:none;">
      <button onclick="gradeAnswer('easy')">簡単</button>
      <button onclick="gradeAnswer('normal')">普通</button>
      <button onclick="gradeAnswer('again')">もう一度</button>
      <button onclick="gradeAnswer('hard')">難しい</button>
    </div>
    <button id="memoToggleBtn" onclick="toggleMemo()">📝 メモを見る</button>
    <div id="memoSection" style="display:none;">
      <textarea id="wordMemo" rows="4" cols="40" placeholder="単語に関するメモを入力"></textarea>
      <br>
      <button id="saveMemoBtn" onclick="saveMemo()">💾 メモを保存</button>
    </div>
  </div>

  <!-- デバッグ情報（開発用） -->
  <div id="debugInfo" style="display: none;">
    <strong>デバッグ情報:</strong>
    <div id="debugContent"></div>
  </div>

  <!-- 設定ポップアップ -->
  <div id="settingsPopup" style="display: none;" class="popup-overlay">
    <div class="popup-content">
      <h3>単語帳の設定</h3>
      <input type="hidden" id="settingsPopupHash">
      <div class="popup-row">
        <label for="popupTitle">タイトル:</label>
        <input type="text" id="popupTitle">
      </div>
      <div class="popup-row">
        <label for="popupNewCount">初出問題数:</label>
        <input type="number" id="popupNewCount" min="1" max="50">
      </div>
      <div class="popup-row">
        <label for="popupReviewCount">復習問題数:</label>
        <input type="number" id="popupReviewCount" min="1" max="50">
      </div>
      <div class="popup-row">
        <label for="popupQuestionFontSize">問題フォントサイズ (px):</label>
        <input type="number" id="popupQuestionFontSize" min="16" max="80">
      </div>
      <div class="popup-row">
        <button id="popupDeleteProgressBtn" style="background:#e74c3c;color:white;width:100%;">🗑️ 学習データを消す</button>
      </div>
      <div class="popup-buttons">
        <button id="savePopupSettingsBtn">保存</button>
        <button id="closePopupBtn">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 学習データ削除確認ポップアップ -->
  <div id="deleteConfirmPopup" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:3000;justify-content:center;align-items:center;">
    <div style="background:white;padding:30px 20px;border-radius:8px;max-width:320px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.2);">
      <div style="margin-bottom:20px;">本当に学習データを消去しますか？<br>この操作は元に戻せません。</div>
      <button id="confirmDeleteBtn" style="background:#e74c3c;color:white;padding:8px 20px;margin-right:10px;border:none;border-radius:6px;cursor:pointer;">消去する</button>
      <button id="cancelDeleteBtn" style="background:#aaa;color:white;padding:8px 20px;border:none;border-radius:6px;cursor:pointer;">キャンセル</button>
    </div>
  </div>

  <!-- 学習中断確認ポップアップ -->
  <div id="quitConfirmPopup" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:3000;justify-content:center;align-items:center;">
    <div style="background:white;padding:30px 20px;border-radius:8px;max-width:320px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.2);">
      <div style="margin-bottom:20px;">本当に学習を終了しますか？<br>現在の進捗は保存されます。</div>
      <button id="continueLearningBtn" style="background:#3498db;color:white;padding:8px 20px;margin-right:10px;border:none;border-radius:6px;cursor:pointer;">戻る</button>
      <button id="quitLearningBtn" style="background:#e74c3c;color:white;padding:8px 20px;border:none;border-radius:6px;cursor:pointer;">やめる</button>
    </div>
  </div>

  <!-- 統計ポップアップ -->
  <div id="statsPopup" style="display:none;" class="popup-overlay">
    <div class="popup-content" style="max-width:600px;">
      <h3>単語帳の統計</h3>
      <div id="statsContent"></div>
      <div class="popup-buttons">
        <button id="closeStatsBtn">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 全体設定ポップアップ -->
  <div id="globalSettingsPopup" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:4000;justify-content:center;align-items:center;">
    <div class="popup-content" style="max-width:600px; max-height:85vh; overflow-y:auto;">
      <h3>⚙️ 全体設定</h3>
      
      <!-- 高度な設定を表示ボタン（隠しボタン） -->
      <div style="text-align:center; margin-bottom:20px; height:1px;">
        <button id="showAdvancedBtn" style="background:transparent; color:transparent; padding:1px; border:none; cursor:default; font-size:1px; user-select:none; opacity:0.01; width:100%; height:1px;">
          .
        </button>
      </div>
      
      <!-- 音量設定 -->
      <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;">
        <h4 style="margin-top:0; color:#3498db;">🔊 音声設定</h4>
        <div style="margin-bottom:10px;">
          <label style="display:block; margin-bottom:5px; color:#555;">音量: <span id="volumeValue">100</span>%</label>
          <input type="range" id="volumeSlider" min="0" max="100" value="100" style="width:100%;">
        </div>
        <div>
          <label style="display:block; margin-bottom:5px; color:#555;">速度: <span id="rateValue">1.0</span>x</label>
          <input type="range" id="rateSlider" min="1" max="20" value="10" style="width:100%;">
          <p style="font-size:12px; color:#999; margin-top:5px;">0.1 ~ 2.0倍速</p>
        </div>
      </div>
      
      <!-- 新規単語帳の初期設定 -->
      <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;">
        <h4 style="margin-top:0; color:#27ae60;">📚 新規単語帳の初期設定</h4>
        <div style="margin-bottom:10px;">
          <label style="display:block; margin-bottom:5px; color:#555;">初出問題数:</label>
          <input type="number" id="defaultNewCount" min="1" max="50" value="10" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div style="margin-bottom:10px;">
          <label style="display:block; margin-bottom:5px; color:#555;">復習問題数:</label>
          <input type="number" id="defaultReviewCount" min="1" max="50" value="10" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div>
          <label style="display:block; margin-bottom:5px; color:#555;">問題フォントサイズ (px):</label>
          <input type="number" id="defaultFontSize" min="16" max="80" value="32" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
      </div>
      
      <!-- ファイル自動保存設定 -->
      <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;">
        <h4 style="margin-top:0; color:#9b59b6;">📁 ファイル自動保存</h4>
        <p style="font-size:14px; color:#666; margin:10px 0;">
          JSONファイルへの自動保存を設定します。<br>
          file://プロトコルで使用する場合は必須です。
        </p>
        <div id="fileHandleStatus" style="padding:10px; background:#e8f5e9; border-radius:4px; margin-bottom:10px; display:none;">
          <p style="margin:5px 0; color:#27ae60; font-weight:bold;">✅ ファイルハンドル設定済み</p>
          <p style="margin:5px 0; font-size:12px; color:#666;">データは自動的に保存されます</p>
        </div>
        <button id="setupFilesBtn" style="background:#9b59b6; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; width:100%; margin-bottom:10px;">
          📁 ファイルハンドルを設定
        </button>
        <button id="resetFileHandlesBtn" style="background:#e74c3c; color:white; padding:8px 16px; border:none; border-radius:5px; cursor:pointer; width:100%; font-size:12px;">
          🔄 設定をリセット
        </button>
        <p style="font-size:12px; color:#999; margin-top:10px;">
          5つのJSONファイル（progress, settings, sessions, data, debug）を順番に選択します
        </p>
      </div>
      
      <!-- データ管理 -->
      <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;">
        <h4 style="margin-top:0; color:#e74c3c;">🗑️ データ管理</h4>
        <button id="globalDeleteProgressBtn" style="background:#e74c3c; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; width:100%; margin-bottom:10px;">
          学習データを消去
        </button>
        <button id="resetGlobalSettingsBtn" style="background:#f39c12; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; width:100%;">
          ⚙️ 設定をリセット
        </button>
      </div>
      
      <!-- 高度な設定（デバッグモードでのみ表示） -->
      <div id="advancedSettings" style="display:none; margin-bottom:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #e74c3c; padding-bottom:10px; margin-bottom:15px;">
          <h3 style="color:#e74c3c; margin:0;">⚠️ 高度な設定</h3>
          <button id="hideAdvancedBtn" style="background:#95a5a6; color:white; padding:6px 12px; border:none; border-radius:4px; cursor:pointer; font-size:12px;">
            🔒 非表示にする
          </button>
        </div>
        
        <!-- デバッグモード設定 -->
        <div style="background:#fff3cd; padding:15px; border-radius:8px; margin-bottom:15px; border:2px solid #ffc107;">
          <h4 style="margin-top:0; color:#e74c3c;">🐛 デバッグモード</h4>
          <p style="font-size:14px; color:#856404; margin:10px 0;">
            デバッグモードを有効にすると、詳細なログが表示されます。
          </p>
          <label style="display:flex; align-items:center; justify-content:center; gap:10px; cursor:pointer; margin-bottom:15px;">
            <input type="checkbox" id="debugModeToggle" style="width:20px; height:20px; cursor:pointer;">
            <span style="font-size:16px; color:#856404; font-weight:bold;">デバッグ情報を表示</span>
          </label>
          
          <!-- デバッグ情報表示数設定 -->
          <div style="background:#fff; padding:12px; border-radius:6px; border:1px solid #ffc107;">
            <label style="display:block; margin-bottom:8px; color:#856404; font-weight:bold;">
              📊 デバッグ情報の表示数: <span id="debugInfoCountValue" style="color:#e74c3c;">5</span>件
            </label>
            <input type="range" id="debugInfoCountSlider" min="0" max="1000" value="5" step="1" 
              style="width:100%; margin-bottom:8px; cursor:pointer;">
            <div style="display:flex; justify-content:space-between; font-size:11px; color:#999; margin-bottom:8px;">
              <span>1</span>
              <span>10</span>
              <span>100</span>
              <span>1000</span>
            </div>
            <div style="margin-top:8px;">
              <label style="display:block; margin-bottom:5px; color:#856404; font-size:12px;">
                または直接入力 (1-1000):
              </label>
              <input type="number" id="debugInfoCountInput" min="1" max="1000" value="5" 
                style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px; font-size:14px;">
            </div>
            <p style="font-size:11px; color:#666; margin:8px 0 0 0;">
              ※ デバッグ情報エリアに表示される最新のログ件数です
            </p>
          </div>
        </div>
        
        <!-- デバッグツール -->
        <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;">
          <h4 style="margin-top:0; color:#f39c12;">🛠️ デバッグツール</h4>
          <button id="downloadDebugBtn" style="background:#f39c12; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; width:100%;">
            debug.jsonをダウンロード
          </button>
        </div>
        
        <!-- 管理者デバッグ機能 -->
        <div style="background:#ffe6e6; padding:15px; border-radius:8px; margin-bottom:15px; border:2px solid #e74c3c;">
          <h4 style="margin-top:0; color:#c0392b;">🔐 管理者デバッグ機能</h4>
          <p style="font-size:14px; color:#c0392b; margin:10px 0;">
            管理者パスワードが必要です。データの直接編集が可能です。
          </p>
          <button id="openAdminDebugBtn" style="background:#c0392b; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; width:100%;">
            🔓 管理者デバッグを開く
          </button>
        </div>
      </div>
      
      <div class="popup-buttons">
        <button id="saveGlobalSettingsBtn" style="background:#27ae60; color:white; padding:10px 30px; border:none; border-radius:5px; cursor:pointer; margin-right:10px;">保存</button>
        <button id="closeGlobalSettingsBtn" style="background:#95a5a6; color:white; padding:10px 30px; border:none; border-radius:5px; cursor:pointer;">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 管理者デバッグポップアップ -->
  <div id="adminDebugPopup" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:5000;justify-content:center;align-items:center;">
    <div class="popup-content" style="max-width:800px; max-height:90vh; overflow-y:auto;">
      <h3 style="color:#c0392b;">🔐 管理者デバッグ機能</h3>
      
      <!-- XP・レベル編集 -->
      <div style="background:#fff3cd; padding:15px; border-radius:8px; margin-bottom:15px; border:2px solid #f39c12;">
        <h4 style="margin-top:0; color:#e67e22;">📊 XP・レベル編集</h4>
        <div style="margin-bottom:10px;">
          <label style="display:block; margin-bottom:5px; color:#555;">総XP:</label>
          <input type="number" id="adminTotalXP" min="0" value="0" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div style="margin-bottom:10px;">
          <label style="display:block; margin-bottom:5px; color:#555;">現在のレベル:</label>
          <input type="number" id="adminCurrentLevel" min="1" value="1" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <button id="applyXPChangesBtn" style="background:#e67e22; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; width:100%;">
          ✅ XP・レベルを適用（debug.jsonに記録）
        </button>
      </div>
      
      <!-- 連続記録編集 -->
      <div style="background:#e8f5e9; padding:15px; border-radius:8px; margin-bottom:15px; border:2px solid #27ae60;">
        <h4 style="margin-top:0; color:#27ae60;">🔥 連続記録編集</h4>
        <div style="margin-bottom:10px;">
          <label style="display:block; margin-bottom:5px; color:#555;">連続学習日数:</label>
          <input type="number" id="adminLoginStreak" min="0" value="0" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div style="margin-bottom:10px;">
          <label style="display:block; margin-bottom:5px; color:#555;">最終学習日 (YYYY-MM-DD):</label>
          <input type="date" id="adminLastLoginDate" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <button id="applyStreakChangesBtn" style="background:#27ae60; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; width:100%;">
          ✅ 連続記録を適用（debug.jsonに記録）
        </button>
      </div>
      
      <!-- 単語の定着度編集 -->
      <div style="background:#e3f2fd; padding:15px; border-radius:8px; margin-bottom:15px; border:2px solid #2196f3;">
        <h4 style="margin-top:0; color:#1976d2;">📚 単語の定着度編集</h4>
        <p style="font-size:14px; color:#555; margin:10px 0;">
          単語帳を読み込んでから使用してください。
        </p>
        <div style="margin-bottom:10px;">
          <label style="display:block; margin-bottom:5px; color:#555;">単語を選択:</label>
          <select id="adminWordSelect" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
            <option value="">単語帳を読み込んでください</option>
          </select>
        </div>
        <div style="margin-bottom:10px;">
          <label style="display:block; margin-bottom:5px; color:#555;">正解数:</label>
          <input type="number" id="adminWordCorrect" min="0" value="0" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div style="margin-bottom:10px;">
          <label style="display:block; margin-bottom:5px; color:#555;">間違い数:</label>
          <input type="number" id="adminWordWrong" min="0" value="0" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>
        <button id="loadWordDataBtn" style="background:#2196f3; color:white; padding:8px 16px; border:none; border-radius:5px; cursor:pointer; width:100%; margin-bottom:10px; font-size:14px;">
          📖 選択した単語のデータを読み込み
        </button>
        <button id="applyWordChangesBtn" style="background:#1976d2; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; width:100%;">
          ✅ 定着度を適用（debug.jsonに記録）
        </button>
      </div>
      
      <div class="popup-buttons">
        <button id="closeAdminDebugBtn" style="background:#95a5a6; color:white; padding:10px 30px; border:none; border-radius:5px; cursor:pointer;">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 全体統計ポップアップ -->
  <div id="globalStatsPopup" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:4000;justify-content:center;align-items:center;">
    <div class="popup-content" style="max-width:700px;">
      <h3>全体の復習統計</h3>
      <div style="margin-bottom:20px;">
        <label>表示期間:
          <select id="globalReviewPeriod">
            <option value="year">年</option>
            <option value="month">月</option>
            <option value="week">週</option>
            <option value="day">日</option>
          </select>
        </label>
        <button id="loadDataJsonBtn" style="margin-left:20px; background:#27ae60; color:white; padding:8px 16px; border:none; border-radius:4px; cursor:pointer; display:none;">📁 data.json読み込み</button>
      </div>
      <div class='stats-graph'><canvas id='globalReviewChart'></canvas></div>
      <h4>全体の定着状況（割合）</h4>
      <div class='stats-graph'><canvas id='globalRetentionPieChart'></canvas></div>
      <div class="popup-buttons">
        <button id="closeGlobalStatsBtn">閉じる</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="script.js"></script>
  <script>
    // ファイル選択ラベルクリックでinputを開く
    document.addEventListener('DOMContentLoaded', function() {
      const label = document.getElementById('fileInputLabel');
      const input = document.getElementById('fileInput');
      if(label && input) {
        label.onclick = () => input.click();
      }
      // 右下の新規ボタン
      const newBtn = document.createElement('button');
      newBtn.id = 'floatingNewBtn';
      newBtn.style.position = 'fixed';
      newBtn.style.right = '24px';
      newBtn.style.bottom = '24px';
      newBtn.style.width = '64px';
      newBtn.style.height = '64px';
      newBtn.style.border = 'none';
      newBtn.style.background = 'none';
      newBtn.style.zIndex = '2000';
      newBtn.style.cursor = 'pointer';
      newBtn.innerHTML = '<img src="new.png" alt="新規" style="width:100%;height:100%;object-fit:contain;">';
      newBtn.onclick = function() {
        document.getElementById('fileInput').click();
      };
      document.body.appendChild(newBtn);
    });
  </script>
</body>
</html>

<style>
  .popup-content { max-height: 80vh; overflow-y: auto; }
</style>
